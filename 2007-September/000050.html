<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Hmgen-svnlog] r51 - trunk
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/hmgen-svnlog/2007-September/index.html" >
   <LINK REL="made" HREF="mailto:hmgen-svnlog%40lists.berlios.de?Subject=Re%3A%20%5BHmgen-svnlog%5D%20r51%20-%20trunk&In-Reply-To=%3C200709032300.l83N0fqH029370%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000049.html">
   <LINK REL="Next"  HREF="000051.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Hmgen-svnlog] r51 - trunk</H1>
    <B>ivop at BerliOS</B> 
    <A HREF="mailto:hmgen-svnlog%40lists.berlios.de?Subject=Re%3A%20%5BHmgen-svnlog%5D%20r51%20-%20trunk&In-Reply-To=%3C200709032300.l83N0fqH029370%40sheep.berlios.de%3E"
       TITLE="[Hmgen-svnlog] r51 - trunk">ivop at mail.berlios.de
       </A><BR>
    <I>Tue Sep  4 01:00:41 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000049.html">[Hmgen-svnlog] r50 - trunk/assist
</A></li>
        <LI>Next message: <A HREF="000051.html">[Hmgen-svnlog] r52 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50">[ date ]</a>
              <a href="thread.html#50">[ thread ]</a>
              <a href="subject.html#50">[ subject ]</a>
              <a href="author.html#50">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ivop
Date: 2007-09-04 01:00:40 +0200 (Tue, 04 Sep 2007)
New Revision: 51

Added:
   trunk/lib_export.c
Modified:
   trunk/Makefile
   trunk/cli_main.c
   trunk/lib_hmgen.h
Log:
move writing of pgm/ppm to its own file


Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2007-09-01 09:39:41 UTC (rev 50)
+++ trunk/Makefile	2007-09-03 23:00:40 UTC (rev 51)
@@ -54,7 +54,7 @@
 
 LIBHMGEN = libhmgen.a
 LIBHMGEN_BASENAMES = lib_algo_ff lib_algo_mpd lib_algo_forge \
-					 lib_postproc lib_util lib_hmgen
+					 lib_postproc lib_util lib_hmgen lib_export
 LIBHMGEN_OBJS = $(addsuffix $(OBJSUF), $(LIBHMGEN_BASENAMES))
 LIBHMGEN_SRCS = $(addsuffix .c, $(LIBHMGEN_BASENAMES))
 

Modified: trunk/cli_main.c
===================================================================
--- trunk/cli_main.c	2007-09-01 09:39:41 UTC (rev 50)
+++ trunk/cli_main.c	2007-09-03 23:00:40 UTC (rev 51)
@@ -174,8 +174,6 @@
 }
 
 int main(int argc, char **argv) {
-    FILE *fp1, *fp2 = NULL;
-
     if (!parse_command_line(argc, argv)) {
         fprintf(stderr, &quot;error, parsing command line\n&quot;);
         exit(1);
@@ -185,21 +183,6 @@
         exit(1);
     }
 
-    fp1 = fopen(outfile, &quot;wb&quot;);
-    if (!fp1) {
-        fprintf(stderr, &quot;error, cannot open %s for writing\n&quot;, outfile);
-        exit(1);
-    }
-
-    if (outputcol) {
-        fp2 = fopen(colfile, &quot;wb&quot;);
-        if (!fp2) {
-            fprintf(stderr, &quot;error, cannot open %s for writing\n&quot;, colfile);
-            fclose(fp1);
-            exit(1);
-        }
-    }
-
     w = h = exp2(size) + 1;
 
     fprintf(stderr, &quot;Dimensions: %i x %i\n&quot;, w, h);
@@ -235,21 +218,15 @@
 
     fprintf(stderr, &quot;Saving to %s\n&quot;, outfile);
 
-    fprintf(fp1, &quot;P5\n# Generated by HMGEN\n%i %i\n255\n&quot;, w, h);
-    fwrite(map, w, h, fp1);
-    fclose(fp1);
+    if (!hmg_export_pgm(outfile, map, w, h))
+        fprintf(stderr, &quot;error during saving\n&quot;);
 
     if (outputcol) {
-        unsigned int i;
         fprintf(stderr, &quot;Saving colorized version to %s\n&quot;, colfile);
 
-        fprintf(fp2, &quot;P6\n# Generated by HMGEN\n%i %i\n255\n&quot;, w, h);
-
         hmg_init_colormap(NULL);
-        for (i=0; i&lt;w*h; i++)
-            fwrite(hmg_colormap[map[i]], 1, 3, fp2);
-
-        fclose(fp2);
+        if (!hmg_export_ppm(colfile, map, w, h))
+            fprintf(stderr, &quot;error during saving\n&quot;);
     }
 
     free(tempmap);

Added: trunk/lib_export.c
===================================================================
--- trunk/lib_export.c	2007-09-01 09:39:41 UTC (rev 50)
+++ trunk/lib_export.c	2007-09-03 23:00:40 UTC (rev 51)
@@ -0,0 +1,75 @@
+#include &lt;stdio.h&gt;
+#include &quot;lib_hmgen.h&quot;
+
+#define HMGEN_MODULE &quot;Export&quot;
+
+static int write_pnm_header(FILE *fp, unsigned int n,
+                            unsigned int w, unsigned int h) {
+    const char *gen_by = &quot;Generated by hmgen&quot;;
+
+    if (fprintf(fp, &quot;P%i\n# %s\n%i %i\n255\n&quot;, n, gen_by, w, h) &lt; 0 )
+        return 0;
+
+    return 1;
+}
+
+unsigned int hmg_export_pgm(const char *filename, unsigned char *map,
+                            unsigned int width, unsigned int height) {
+    FILE *fp;
+    unsigned int y;
+
+    fp = fopen(filename, &quot;wb&quot;);
+
+    if (!fp)
+        return 0;
+
+    if (!write_pnm_header(fp, 5, width, height))
+        goto err_out;
+
+    for (y=0; y&lt;height; y++) {
+        progress_meter(y*100.0/height);
+        if (fwrite(map+y*width, width, 1, fp) != 1)
+            goto err_out;
+    }
+
+    progress_meter(-1);
+
+    return !fclose(fp);
+
+err_out:
+    fclose(fp);
+    progress_meter(-1);
+    return 0;
+}
+
+unsigned int hmg_export_ppm(const char *filename, unsigned char *map,
+                            unsigned int width, unsigned int height) {
+    FILE *fp;
+    unsigned int x, y;
+
+    fp = fopen(filename, &quot;wb&quot;);
+
+    if (!fp)
+        return 0;
+
+    if (!write_pnm_header(fp, 6, width, height))
+        goto err_out;
+
+    for (y=0; y&lt;height; y++) {
+        progress_meter(y*100.0/height);
+        for (x=0; x&lt;width; x++) {
+            if (fwrite(hmg_colormap[map[y*width+x]], 1, 3, fp) != 3)
+                goto err_out;
+        }
+    }
+
+    progress_meter(-1);
+
+    return !fclose(fp);
+
+err_out:
+    fclose(fp);
+    progress_meter(-1);
+    return 0;
+}
+

Modified: trunk/lib_hmgen.h
===================================================================
--- trunk/lib_hmgen.h	2007-09-01 09:39:41 UTC (rev 50)
+++ trunk/lib_hmgen.h	2007-09-03 23:00:40 UTC (rev 51)
@@ -49,6 +49,11 @@
 void hmg_rng_initgauss(unsigned int seed);
 double hmg_rng_gauss(void);
 
+unsigned int hmg_export_pgm(const char *filename, unsigned char *map,
+                            unsigned int width, unsigned int height);
+unsigned int hmg_export_ppm(const char *filename, unsigned char *map,
+                            unsigned int width, unsigned int height);
+
 #ifdef __GNUC__
 #define HMG_ATTR_UNUSED     __attribute__((unused))
 #else


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000049.html">[Hmgen-svnlog] r50 - trunk/assist
</A></li>
	<LI>Next message: <A HREF="000051.html">[Hmgen-svnlog] r52 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50">[ date ]</a>
              <a href="thread.html#50">[ thread ]</a>
              <a href="subject.html#50">[ subject ]</a>
              <a href="author.html#50">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/hmgen-svnlog">More information about the Hmgen-svnlog
mailing list</a><br>
</body></html>
